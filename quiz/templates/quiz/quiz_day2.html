
{% extends 'quiz/base.html' %}

{% block main %}
<!-- ใช้ json_script สำหรับแปลง questions เป็น JSON ที่ปลอดภัย -->

<div class="container mx-auto py-10">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-blue-600">Quiz Game</h1>
        <p class="text-gray-600">ตอบคำถามภายในเวลาที่กำหนด!</p>
    </div>
    {% if error %}
        <p>{{ error }}</p>
    {% else %}
        <h1>แบบทดสอบ: รอบที่ {{ attempt.attempt_number }}</h1>
    {% endif %}
    <div class="container mx-auto p-4" x-data="quizApp()" x-init="startQuiz()">
        <div x-show="currentQuestionIndex < questions.length">
            <h1 class="text-2xl font-bold mb-4" x-text="questions[currentQuestionIndex].text"></h1> 
            <!-- <input x-model="selectedAnswer"> -->
            <template  x-for="(choice, index) in questions[currentQuestionIndex].choices" :key="choice.id">
                <label
                    x-bind:class="{
                        'bg-red-500 text-white': selectedAnswer !== choice.id && index % 4 === 0,
                        'bg-blue-500 text-white': selectedAnswer !== choice.id && index % 4 === 1,
                        'bg-green-500 text-white': selectedAnswer !== choice.id && index % 4 === 2,
                        'bg-yellow-500 text-white': selectedAnswer !== choice.id && index % 4 === 3,
                        'bg-red-900 text-white': selectedAnswer == choice.id && index % 4 === 0,
                        'bg-blue-900 text-white': selectedAnswer == choice.id && index % 4 === 1,
                        'bg-green-900 text-white': selectedAnswer == choice.id && index % 4 === 2,
                        'bg-yellow-900 text-white': selectedAnswer == choice.id && index % 4 === 3,
                    }"
                    class="p-4 rounded-lg flex my-2 cursor-pointer justify-center"
                
                > 
                <!-- or can use forloop.counter0 get number -->
                    <input type="radio" :id="'choice-' + choice.id" :name="'question-' + questions[currentQuestionIndex].id" :value="choice.id" x-model="selectedAnswer" class="hidden">
                    <span x-text="choice.text"></span>
                    <span x-text="choice.id"></span>
                    <span x-text="index"></span>
                </label>
            </template>

            <div class="text-red-600 text-lg mt-4">เวลาที่เหลือ: <span x-text="timeRemaining"></span></div>
        </div>

        <div x-show="currentQuestionIndex >= questions.length">
            <h1 class="text-2xl font-bold">คุณทำแบบทดสอบเสร็จแล้ว!</h1>
            <button onclick="goToResultPage()" class="btn btn-primary mt-5">
                ไปยังหน้าผลลัพธ์
            </button>
        </div>
    </div>
</div>
    

<script>
    function goToResultPage() {
        window.location.href = "{% url 'quiz-results2' %}";
    }
    function quizApp() {
        return {
            questions: [],
            currentQuestionIndex: 0,
            timeRemaining: 10,
            timer: null,
            selectedAnswer: null,

            // โหลดคำถามจาก backend (ใช้ htmx)
            async startQuiz() {
                this.questions =  await (await fetch('/quiz-data')).json();
                this.startTimer();
            },

            async submitAnswer() {
                // ส่งคำตอบไปยัง backend
                const formData = new FormData();
                formData.append('question_id', this.questions[this.currentQuestionIndex].id);
                formData.append('choice_id', this.selectedAnswer);
                if (this.selectedAnswer) {
                    await fetch('/submit-answer/', {
                        method: 'POST',
                        headers: {
                            //'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: formData
                    });
                }
                this.selectedAnswer = null;
                this.nextQuestion();  // โหลดคำถามถัดไป
            },

            // จัดการเปลี่ยนคำถามเมื่อหมดเวลา
            startTimer() {
                this.timer = setInterval(() => {
                    if (this.timeRemaining > 0) {
                        this.timeRemaining--;
                    } else {
                        this.submitAnswer();
                        //this.nextQuestion();
                    }
                }, 1000);
            },

            // เปลี่ยนไปยังคำถามถัดไป
            nextQuestion() {
                clearInterval(this.timer);
                this.selectedAnswer = null;  // ล้างการเลือกคำตอบ
                this.timeRemaining = 10; // ตั้งเวลาใหม่ 
                this.currentQuestionIndex++;
                if (this.currentQuestionIndex < this.questions.length) {
                    this.startTimer();
                }
                else {
                    this.finishQuiz()
                }
            },
            
            finishQuiz() {
                fetch('/calculate-score/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }).then(response => {
                    if (response.ok) {
                        console.log("Send to backend!");
                    }
                });
            }
        };
    }
</script>
{% endblock %}